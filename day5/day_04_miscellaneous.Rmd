---
title: "Day 4. Miscellaneous"
author: "Nicholas Michalak"
date: "7/14/2017"
output: 
  html_document:
    fig_height: 7.5
    fig_width: 10.5
    keep_md: yes
    theme: readable
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

# load packages

```{r}

# character vector of packages you'll need for your whole analysis
needed_packages <- c("tidyverse", "stringr", "haven", "readxl", "psych", "officer", "rvg", "broom", "lme4", "lavaan")

# source custom function
source("custom_functions/install_needed_pkgs.R")

# install needed packages
install_needed_pkgs(needed_packages = needed_packages)

```

# read data

```{r}

add_health <-
"~/Desktop/R_programming_for_research/day_01_data_import_and_visualization/example_tidy_data/ICPSR_21600/DS0001/21600-0001-Data.sav" %>%
  read_spss()

```

# some descriptives

## age
> HOW OLD ARE YOU?

### counts

```{r}

add_health %>%
  count(S1)

```

### convert to number and then describe

```{r}

add_health %>%
  mutate(age = S1 %>% parse_number()) %>%
  select(age) %>%
  psych::describe()

```

### histogram

```{r}

add_health %>%
  ggplot(aes(x = S1)) +
  geom_histogram(binwidth = 1, bins = 10, color = "white") +
  scale_x_continuous(breaks = seq(9, 20, 1)) +
  coord_cartesian(xlim = c(10, 19))

```

## sex
> WHAT SEX ARE YOU?

### counts

```{r}

add_health %>%
  mutate(sex = S2 %>%
           parse_character() %>%
           recode(`1` = "Male", `2` = "Female")) %>%
  count(sex)

```

# Section 8: Pregnancy, AIDS, and STD Risk Perceptions

```{r}

add_health %>%
  select(AID, num_range(prefix = "H1RP", range = 1:6)) %>%
  gather(key = question, value = response, -AID) %>%
  ggplot(mapping = aes(x = response)) +
  geom_histogram(binwidth = 1, color = "white") +
  facet_wrap(~ question)

```

## scatterplot matrix

```{r}

add_health %>%
  select(AID, num_range(prefix = "H1RP", range = 1:6)) %>%
  pairs.panels(pch = ".")

```

# Section 9: Self Efficacy

## histograms

```{r}

add_health %>%
  select(AID, num_range(prefix = "H1SE", range = 1:4)) %>%
  gather(variable, value, -AID) %>%
  ggplot(mapping = aes(x = value)) +
  geom_histogram(binwidth = 1, color = "white") +
  facet_wrap(~ variable)

```

## scatterplot matrix

```{r}

add_health %>%
  select(AID, num_range(prefix = "H1SE", range = 1:4)) %>%
  pairs.panels(pch = ".")

```

# create slides with these plots

## create rpptx object with `read_pptx()`

```{r}

my_pptx <- read_pptx()

```

## `add_slide()` and `last_plot()`

```{r}

# add slide
# add plot with vector graphics
# ?last_plot()
# print result to filepath
my_pptx <-
my_pptx %>%
  add_slide(layout = "Title and Content", master = "Office Theme") %>% 
  ph_with_vg(code = last_plot() %>% print(), type = "body") %>% 
  print(target = "my_histogram.pptx")
  
```

# for loop example

```{r}

# read: for every i in 1 to 10, print i
for(i in 1:10) {
  
  print(i)
  
}

```

# map functions examples

```{r}

# for every subject id, plot a scatterplot and fit OLS best fit line
# facet / subplot by Subject
sleepstudy$Subject %>%
  unique() %>%
  map(function(id) {
  
  sleepstudy %>%
      filter(Subject == id) %>%
      ggplot(aes(x = Days, y = Reaction)) +
      geom_point() +
      stat_smooth(method = "lm", se = FALSE, fullrange = TRUE) +
      facet_wrap(~ Subject)
  
})

```

# lmm examples
> see Bates, D., MÃ¤chler, M., Bolker, B., & Walker, S. (2014). [Fitting linear mixed-effects models using lme4](https://arxiv.org/abs/1406.5823). arXiv preprint arXiv:1406.5823 and also Bates, D. M. (2010). [lme4: Mixed-effects modeling with R](http://lme4.0.r-forge.r-project.org/lMMwR/lrgprt.pdf).

# notes on lmm / lme4 p-values 

```{r}

help("pvalues")

```

## random intercept with fixed mean

```{r}

# fit model
lmm_1 <- lmer(Reaction ~ Days + (1 | Subject), data = sleepstudy, REML = TRUE)

# fit summary
lmm_1 %>%
  summary()

# bootstrapped confidence intervals
lmm_1 %>%
  confint(method = "boot")

# alternative fit (i.e. same model, more typing)
lmm_1_alt <- lmer(Reaction ~ 1 + Days + (1 | Subject), data = sleepstudy, REML = TRUE)

# check to make sure
anova(lmm_1, lmm_1_alt)

```

## intercept varying among group 1 and group 2 within group 1 (i.e. nesting)

```{r}

# fit model
lmm_2 <- lmer(strength ~ 1 + (1 | batch / cask), data = Pastes, REML = TRUE)

# fit summary
lmm_2 %>%
  summary()

# bootstrapped confidence intervals
lmm_2 %>%
  confint(method = "boot")

# alternative fit (i.e. same model, more typing)
lmm_2_alt <- lmer(strength ~ 1 + (1 | batch) + (1 | batch:cask), data = Pastes, REML = TRUE)

# check to make sure
anova(lmm_2, lmm_2_alt)

```

## intercept varying among group 1 and group 2

```{r}

# fit model
lmm_3 <- lmer(diameter ~ 1 + (1 | plate) + (1 | sample), data = Penicillin, REML = TRUE)

# fit summary
lmm_3 %>%
  summary()

# bootstrapped confidence intervals
lmm_3 %>%
  confint(method = "boot")

# alternative fit (i.e. same model, less typing)
lmm_3_alt <- lmer(diameter ~ (1 | plate) + (1 | sample), data = Penicillin, REML = TRUE)

# check to make sure
anova(lmm_3, lmm_3_alt)

```

## Correlated random intercept and slope.

```{r}

# fit model
lmm_4 <- lmer(Reaction ~ Days + (Days | Subject), data = sleepstudy, REML = TRUE)

# fit summary
lmm_4 %>%
  summary()

# bootstrapped confidence intervals
lmm_4 %>%
  confint(method = "boot")

# alternative fit (i.e. same model, more typing)
lmm_4_alt <- lmer(Reaction ~ 1 + Days + (1 + Days | Subject), data = sleepstudy, REML = TRUE)

# check to make sure
anova(lmm_4, lmm_4_alt)

```

## Uncorrelated random intercept and slope.

```{r}

# fit model
lmm_5 <- lmer(Reaction ~ Days + (Days || Subject), data = sleepstudy, REML = TRUE)

# fit summary
lmm_5 %>%
  summary()

# bootstrapped confidence intervals
lmm_5 %>%
  confint(method = "boot")

# alternative fit (i.e. same model, more typing)
lmm_5_alt <- lmer(Reaction ~ 1 + Days + (1 | Subject) + (0 + Days | Subject), data = sleepstudy, REML = TRUE)

# check to make sure
anova(lmm_5, lmm_5_alt)

```
