---
title: "Day 1. Data import and Data Visualization"
author: "Nicholas Michalak"
date: "6/25/2017"
output: 
  html_document:
    fig_height: 7.5
    fig_width: 10.5
    keep_md: yes
    theme: readable
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

# install prerequisite packages

```{r}

# character vector of packages you'll need for your whole analysis
needed_packages <- c("tidyverse", "stringr", "haven", "readxl")

# source custom function
source("custom_functions/install_needed_pkgs.R")

# install needed packages
install_needed_pkgs(needed_packages = needed_packages)

```

#  Basic piping

## `x %>% f` is equivalent to `f(x)`

```{r}

# 10 values drawn from normal distribution, mean = 0, sd = 1
# set randomizer seed first so results can be reproduced
set.seed(12)
ten_rnorm_x <- rnorm(n = 10, mean = 0, sd = 1)

# mean
# with pipes
ten_rnorm_x %>% mean(.)

# without pipes
mean(ten_rnorm_x)

```

## `x %>% f(y)` is equivalent to `f(x, y)`

```{r}

# create new variable with r ~ 0.5 correlation with first variable
# set randomizer seed first so results can be reproduced
set.seed(123)
ten_rnorm_y <- ten_rnorm_x * 0.5 + rnorm(n = 10, mean = 0, sd = 1)

# correlation between five_rnorm_x and five_rnorm_y
# with pipes
ten_rnorm_x %>% cor(ten_rnorm_y)

# without pipes
cor(ten_rnorm_x, ten_rnorm_y)

```

## `x %>% f %>% g %>% h` is equivalent to `h(g(f(x)))`

```{r}

# extract numbers from characters
# mean center those numbers
# convert list (the result of the scale function) to a number
# with pipes
c("s1z", "n2w", "o3q", "g4s", "d5a") %>%
  parse_number() %>%
  scale(center = TRUE, scale = FALSE) %>%
  parse_number()

# without pipes
parse_number(
  scale(
    parse_number(
      c("s1z", "n2w", "o3q", "g4s", "d5a")
      ), center = TRUE, scale = FALSE
    )
  )

```

## a more practical example

```{r}

# using the mpg dataset (?mpg)
# filter out cars that have less than 6 litre engine displacement
# and then select only manufacturer, class, city, and highway
# and then, finally, plot hwy on cty, coloring the points by class and
# faceting the plots by manufacturer
mpg %>%
  filter(displ < 6) %>%
  select(manufacturer, class, cty, hwy) %>%
  ggplot(aes(x = cty, y = hwy, color = class)) +
  geom_point() +
  facet_wrap(~ manufacturer)

```

# classic example: Anscombe's Quartet

## fit linear rgeression for first set

```{r}

model_1 <- lm(y1 ~ x1, data = anscombe)

# summarize
summary(model_1)

```

## fit linear rgeression for second set

```{r}

model_2 <- lm(y2 ~ x2, data = anscombe)

# summarize
summary(model_2)

```

## fit linear rgeression for third set

```{r}

model_3 <- lm(y3 ~ x3, data = anscombe)

# summarize
summary(model_3)

```

## fit linear rgeression for fourth set

```{r}

model_4 <- lm(y4 ~ x4, data = anscombe)

# summarize
summary(model_4)

```

## plot all four sets

```{r}

# start with anscombe dataset that comes with R
# select variables x1 through x4b n 
# gather columns into pairs: name the variable "set" and the value "x"
# write over the "set" variable with a new variable that replaces "x" with ""
# save result as "anscombe_x"
(anscombe_x <- 
anscombe %>%
  select(x1:x4) %>%
  gather(set, x) %>%
  mutate(set = str_replace(string = set, pattern = "x", replacement = "")) %>%
  as_tibble())

# start with anscombe dataset that comes with R
# select variables y1 through y4
# gather columns into pairs: name the variable "set" and the value "y"
# write over the "set" variable with a new variable that replaces "y" with ""
# save result as "anscombe_y"
(anscombe_y <- 
anscombe %>%
  select(y1:y4) %>%
  gather(set, y) %>%
  mutate(set = str_replace(string = set, pattern = "x", replacement = "")) %>%
  as_tibble())

# bind those datasets above by columns
# however, remove the set variable from the anscombe_y dataset
(anscombe_long <- bind_cols(anscombe_x, anscombe_y %>%
                             select(-set)))

anscombe_long %>%
  ggplot(aes(x = x, y = y)) +
  geom_point() +
  stat_smooth(method = "lm", se = FALSE, fullrange = TRUE) +
  scale_x_continuous(breaks = 3:20, limits = c(3, 20)) +
  scale_y_continuous(breaks = 3:13, limits = c(3, 13)) +
  coord_cartesian(xlim = c(4, 19), ylim = c(4, 13)) +
  facet_wrap(~ set)

```

# modern example: Datasaurus
> Matejka, J., & Fitzmaurice, G. (2017, May). [Same stats, different graphs: Generating datasets with varied appearance and identical statistics through simulated annealing](https://www.autodeskresearch.com/publications/samestats). In Proceedings of the 2017 CHI Conference on Human Factors in Computing Systems (pp. 1290-1294). ACM.

## see it

```{r}

(datasaurus <- "example_tidy_data/datasaurus_dozen.tsv" %>%
  read_tsv())
  
```

## describe it

```{r}

datasaurus$dataset %>%
  unique() %>%
  map_df(function(set) {
    
    r <- datasaurus %>%
      filter(dataset == set) %>%
      with(., cor(x, y))
    
    datasaurus %>%
      filter(dataset == set) %>%
      summarise(n = n(),
                mean_x = mean(x),
                sd_x = sd(x),
                mean_y = mean(y),
                sd_y = sd(y),
                se = ) %>%
      mutate(r_xy = r,
             dataset = set) %>%
      select(dataset, n, everything(.))
    
  })

```

## plot it

```{r}

datasaurus %>%
  ggplot(aes(x = x, y = y)) +
  geom_point() +
  facet_wrap(~ dataset)

```

# psychology example 1

> (Adapted from Maxwell & Delaney, 1990, p 300, quest #9) A clinical psychologist wants to compare three types of therapy for snake phobia. However, she does not believe that one type of therapy is necessarily best for everyone; the best therapy may depend on the severity level of the client's phobia. Undergraduate students enrolled in an introductory psychology course were given a Fear Inventory to screen out subjects showing no fear of snakes. Those displaying some degree of snake phobia were classified as either mildly or severely phobic. Subjects were then randomly assigned to one of three treatment conditions: systematic desensitization, implosive therapy, or insight therapy. The following data are from a well-accepted phobia scale (higher scores indicate less phobia). You don't need to know anything about the conceptual differences between these three therapies or the phobia scale to answer the following questions. To save time, no need to check assumptions for this problem set but don't skip this step when you analyze real data in your research.

```{r}

# source example data
source("example_tidy_data/snake_phobia.R")

# view descriptives for snake therapy data
snk_thrpy_desc

```

## plot means from table of descriptives

```{r}

ggplot(data = snk_thrpy_desc, aes(x = therapy, y = mean_phobia, fill = severity)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
  geom_errorbar(mapping = aes(ymin = mean_phobia - moe_phobia, ymax = mean_phobia + moe_phobia), position = position_dodge(width = 0.9), width = 0.1)

```

## plot means from raw data

```{r}

ggplot(data = snakes_therapy, aes(x = therapy, y = phobia, fill = severity)) +
  stat_summary(fun.data = "mean_cl_normal", geom = "bar", position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_normal", geom = "errorbar", position = position_dodge(width = 0.9), width = 0.1)

```

# psychology example 2

> adapted from figure 1 from Tybur et al. (2016)

* The scatterplot displays the relationship between national parasite stress and traditionalism (r = 0.70). Each data point [labeled with a two-letter country code (abbreviations defined in Table 1)] represents a nation's mean traditionalism, controlling for sample demographic characteristics (age and sex).
* To facilitate visual interpretation of results (Figs. 1–3), we added a constant to each nation’s parasite stress score so that the lowest scoring country (Canada) had a value of zero.

```{r}

# source example data
source("example_tidy_data/tybur_et_al_fig_1.R")

# view data for plot
tybur_et_al_fig1

```

## scatterplot with 95% confidence ribbons country labels

```{r}

ggplot(data = tybur_et_al_fig1, aes(x = hist_path_rscld, y = traditionalism, label = country)) +
  geom_point(size = 3, alpha = 0.4, color = "blue") +
  geom_smooth(method = "lm", color = "blue") +
  scale_x_continuous(breaks = seq(0, 2.5, 0.25), limits = c(0, 2.5)) +
  scale_y_continuous(breaks = seq(0, 3.5, 0.25), limits = c(0, 3.5)) +
  geom_text(check_overlap = TRUE, nudge_x = 0.025, nudge_y = -0.075) +
  labs(x = "Parasite Stress", y = "Traditionalism") +
  theme_minimal() +
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 14))

```

## compare this to published figure

![Figure 1.](example_tidy_data/tybur_et_all_figures/tybur_et_al_figure_1.jpg)

# import data

## csv

```{r}

(murray_schaller <- "example_tidy_data/tybur_et_al_data/tabula-murray_schaller_2010_journal_of_cross_cultural_psychology.csv" %>%
  read_csv())

```

## tsv

```{r}

(add_health_tsv <- "example_tidy_data/ICPSR_21600/DS0001/21600-0001-Data.tsv" %>%
  read_tsv(.))

```

## Excel / xls / xlsx

```{r}

# note: can also use read_excel()
(tybur_et_al_sO1 <- "example_tidy_data/tybur_et_al_data/pnas.1607398113.sd01.xlsx" %>%
  read_xlsx())

```

## SPSS / sav

```{r}

# note: can also use read_spss()
(add_health_sav <- "example_tidy_data/ICPSR_21600/DS0001/21600-0001-Data.sav" %>%
  read_sav())

```

## Stata / dta

```{r}

# note: can also use read_stata()
(add_health_dta <- "example_tidy_data/ICPSR_21600/DS0001/21600-0001-Data.dta" %>%
  read_dta())

```
