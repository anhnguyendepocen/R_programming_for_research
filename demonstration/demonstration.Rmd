---
title: "demonstration"
author: "Nicholas Michalak"
date: "6/20/2017"
output: html_document
---

# packages

```{r}
# character vector of packages I want
want_packages <- c("tidyverse", "psych", "afex", "lavaan", "lme4", "lmerTest", "readxl", "lsmeans")

# which of these packages do I already have (logical vector, TRUE / FALSE)
have_packages <- want_packages %in% rownames(installed.packages())

# if I don't have a package, install it
if(any(have_packages == FALSE))
  install.packages(want_packages[have_packages == FALSE])

# load wanted packages
lapply(want_packages, library, character.only = TRUE)

```

# data

## supplementary xlsx

```{r}
# read and save data from xlsx file
tybur_et_al_SO1 <- "tybur_et_al_data/pnas.1607398113.sd01.xlsx" %>%
  read_xlsx() %>%
  mutate(sex = factor(sex,
                      levels = c(1, 2),
                      labels = c("Man", "Woman")))

# nation codes from Tybur email
tybur_et_al_nation_codes <- "tybur_et_al_data/pnas.1607398113.sd01_nation_codes.xlsx" %>%
  read_xlsx() %>%
  mutate(country = factor(country,
                          levels = unique(country),
                          labels = unique(country)))

# join
tybur_et_al_SO1 <- tybur_et_al_SO1 %>%
  full_join(., tybur_et_al_nation_codes, by = "nation")
  
```

# reproduce scatterplots from Tybur et al.

## figure 1
* The scatterplot displays the relationship between national parasite stress and traditionalism (r = 0.70). Each data point [labeled with a two-letter country code (abbreviations defined in Table 1)] represents a nation's mean traditionalism, controlling for sample demographic characteristics (age and sex).
* To facilitate visual interpretation of results (Figs. 1–3), we added a constant to each nation’s parasite stress score so that the lowest scoring country (Canada) had a value of zero.

```{r}

# remember contrasts
contrasts(tybur_et_al_SO1$country)
contrasts(tybur_et_al_SO1$sex)

tybur_et_al_SO1 %>%
  lm(Traditionalim ~ country + age + sex, data = .) %>%
  lsmeans::lsmeans(specs = "country") %>%
  summary(.) %>%
  full_join(., tybur_et_al_SO1 %>%
              select(country, HistPath),
            by = "country") %>%
  group_by(country, HistPath) %>%
  summarise(traditionalism = mean(lsmean)) %>%
  mutate(HistPath = HistPath + 1.31) %>%
  ggplot(aes(x = HistPath, y = traditionalism, label = country)) +
  geom_point(size = 3, alpha = 0.4, color = "blue") +
  geom_smooth(method = "lm", color = "blue") +
  scale_x_continuous(breaks = seq(0, 2.5, 0.25), limits = c(0, 2.5)) +
  scale_y_continuous(breaks = seq(0, 3.5, 0.25), limits = c(0, 3.5)) +
  geom_text(check_overlap = TRUE, nudge_x = 0.025, nudge_y = -0.075) +
  labs(x = "Parasite Stress", y = "Traditionalism") +
  theme_minimal()
```

![Figure 1.](tybur_et_all_figures/tybur_et_al_figure_1.jpg)

